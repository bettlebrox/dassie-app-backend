// The Dev Container format allows you to configure your environment. At the heart of it
// is a Docker image or Dockerfile which controls the tools available in your environment.
//
// See https://aka.ms/devcontainer.json for more information.
{
	"name": "Gitpod",
	// Use "image": "mcr.microsoft.com/vscode/devcontainers/base:ubuntu",
	// instead of the build to use a pre-built image.
	"build": {
        "context": ".",
        "dockerfile": "Dockerfile"
    },
	"containerEnv": {
		"AWS_ACCOUNT_ID": "559845934392",
		"AWS_DEFAULT_REGION": "eu-west-1"
	},
	// Features add additional features to your environment. See https://containers.dev/features
	// Beware: features are not supported on all platforms and may have unintended side-effects.
	"features": {
        "ghcr.io/devcontainers/features/python:1": {"version": "3.9.18"},
		"ghcr.io/devcontainers/features/aws-cli:1": {},
        "ghcr.io/devcontainers/features/node:1": {},
		"ghcr.io/devcontainers/features/docker-in-docker": {},
		"ghcr.io/devcontainers-extra/features/aws-cdk:2": {}
	},
	"customizations": {
		"vscode": {
			"extensions": ["ms-python.python", "ms-python.debugpy"],
			"tasks": {
				"deploy": {
					"label": "Deploy CDK Stack",
					"type": "terminal",
					"command": "cdk deploy --all",
					"problemMatcher": []
				},
				"synth": {
					"label": "Synthesize CDK Stack",
					"type": "shell",
					"command": "env LOCAL_TESTING=true cdk synth --no-staging",
					"problemMatcher": []
				},
				"start-api": {
					"label": "Start API",
					"type": "shell",
					"command": "sam local start-api -t ./cdk.out/LocalStack.template.json  --warm-containers lazy --env-vars python/lambda/local.json --log-file /tmp/local-start-api.log",
					"problemMatcher": []
				},
				"tail-api": {
					"label": "Tail API",
					"type": "shell",
					"command": "tail -f /tmp/local-start-api.log | jq -R -r '. as $line | try (fromjson | .timestamp +\"\\t\"+.function_request_id +\"\\t\" + .function_name +\"\\t\"+.level +\"\\t\"+.location +\"\\t\"+.message + \"\\t\" + .exception +\"\\t\" + .query) catch $line'",
					"problemMatcher": []
				}
			}
		}
	},
	"postCreateCommand": "pip install -r requirements.txt && git config --global user.email \"474346+bettlebrox@users.noreply.github.com\""
}
