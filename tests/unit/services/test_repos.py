from unittest.mock import MagicMock
import sys
import os
from urllib.parse import quote_plus
from datetime import datetime

sys.path.append(
    os.path.join(os.path.dirname(os.path.realpath(__file__)), "../../../python/lambda")
)
from models import Article, Theme
from repos import ArticleRepository, ThemeRepository


def test_get_all_articles():
    # Create a mock session and query
    mock_session = MagicMock()
    mock_session.return_value.query.return_value.all.return_value = [
        Article(
            title="Test Article 1",
            summary="This is a test article",
            url="https://example.com",
        ),
        Article(
            title="Test Article 2",
            summary="This is another test article",
            url="https://example.com",
        ),
    ]

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Call the get_all method
    articles = repo.get_all()

    # Assert the result
    assert articles[0]._title == quote_plus("Test Article 1")
    assert articles[1]._title == quote_plus("Test Article 2")


def test_get_article_by_id():
    # Create a mock session
    mock_session = MagicMock()
    mock_session.return_value.query.return_value.get.return_value = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Call the get_by_id method
    article = repo.get_by_id(1)

    # Assert the result
    assert article._title == quote_plus("Test Article")


def test_add_article():
    # Create a mock session
    mock_session = MagicMock()
    mock_session.return_value.merge.return_value = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Create a new article
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )

    # Call the add method
    added_article = repo.add(article)

    # Assert the result
    assert added_article.original_title == "Test Article"


def test_delete_article():
    # Create a mock session
    mock_session = MagicMock()

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Create a new article
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )

    # Call the delete method
    repo.delete(article)

    # Assert that the session's delete and commit methods were called
    mock_session.return_value.delete.assert_called_with(article)
    mock_session.return_value.commit.assert_called()


def test_update_article():
    # Create a mock session
    mock_session = MagicMock()

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Create a new article
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )

    # Call the update method
    repo.update(article)

    # Assert that the session's merge and commit methods were called
    mock_session.return_value.merge.assert_called_with(article)
    mock_session.return_value.commit.assert_called()


def test_get_article_by_url():
    # Create a mock session and query
    mock_query = MagicMock()
    mock_session = MagicMock()
    mock_session.return_value.query.return_value = mock_query

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Mock the query result
    mock_query.filter_by.return_value.all.return_value = [
        Article(
            title="Test Article",
            url="https://example.com",
            summary="This is a test article",
        )
    ]
    mock_session.return_value.merge.return_value = Article(
        title="Test Article",
        url="https://example.com",
        summary="This is a test article",
    )

    # Call the get_by_url method
    article = repo.get_by_url("https://example.com")

    # Assert the result
    assert article.original_title == "Test Article"


def test_upsert_article():
    # Create a mock session and query
    mock_query = MagicMock()
    mock_session = MagicMock()
    mock_session.return_value.query.return_value = mock_query

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Mock the query result
    mock_query.filter_by.return_value.all.return_value = []

    # Create a new article
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )
    article.logged_at = datetime.strptime(
        "2024-03-23T09:21:54.524395", "%Y-%m-%dT%H:%M:%S.%f"
    )
    # Call the upsert method
    mock_session.return_value.merge.return_value = article
    upserted_article = repo.upsert(article)

    # Assert the result
    assert upserted_article.original_title == "Test Article"
    assert upserted_article.logged_at == datetime.strptime(
        "2024-03-23T09:21:54.524395", "%Y-%m-%dT%H:%M:%S.%f"
    )


def test_get_articles_by_theme():
    # Create a mock session and query
    mock_query = MagicMock()
    mock_session = MagicMock()
    mock_session.return_value.query.return_value = mock_query
    query_embedding = [
        -0.023027408868074417,
        0.012609250843524933,
        -0.004424053709954023,
        -0.026893222704529762,
        0.00014315808948595077,
        0.03165221959352493,
        -0.014165345579385757,
        -0.003928615245968103,
        -0.011548594571650028,
        -0.02439509704709053,
        0.028149262070655823,
        -0.007494374644011259,
        -0.0037506762892007828,
        0.000983026111498475,
        -0.01949653960764408,
        -0.01949653960764408,
        0.01752874255180359,
        0.0074455286376178265,
        0.02083631604909897,
        -0.010648432187736034,
        -0.021129392087459564,
        0.032489579170942307,
        0.0023236749693751335,
        -0.013314029201865196,
        0.000125822116388008,
        -0.014584025368094444,
        -0.005704517010599375,
        -0.041951753199100494,
        0.013376831077039242,
        -0.021129392087459564,
        0.020947962999343872,
        -0.02393454872071743,
        -0.005027650855481625,
        -0.021589940413832664,
        -0.013495457358658314,
        0.00420075748115778,
        0.004521745722740889,
        -0.01533764973282814,
        0.019622143357992172,
        0.014863145537674427,
        0.024632349610328674,
        0.011681176722049713,
        -0.000307468231767416,
        -0.01553303375840187,
        -0.015630725771188736,
        0.03823945298790932,
        -0.02147829160094261,
        -0.021143347024917603,
        -0.02313905581831932,
        0.007578110788017511,
        0.003119167173281312,
        0.019468627870082855,
        -0.01305584330111742,
        -0.019719835370779037,
        -0.00196605222299695,
        0.016230834648013115,
        0.0018945276970043778,
        0.026404762640595436,
        -0.00015983986668288708,
        -0.009203985333442688,
        -0.006932645570486784,
        -0.029447171837091446,
        -0.016900721937417984,
        0.013153535313904285,
        -0.0006755578797310591,
        0.0036006493028253317,
        -0.0020585106685757637,
        0.019133683294057846,
        0.022832024842500687,
        0.006213911343365908,
        0.019161595031619072,
        0.017570611089468002,
        -0.007543220650404692,
        0.007152452599257231,
        0.035671550780534744,
        0.004211224615573883,
        -0.0010938019258901477,
        0.008317778818309307,
        -0.010564696043729782,
        0.019622143357992172,
        0.004340317565947771,
        0.0008290739497169852,
        0.0012900582514703274,
        0.017096105962991714,
        0.031373098492622375,
        0.02002686820924282,
        -0.0005630375817418098,
        0.03184760361909866,
        -0.019398847594857216,
        -0.008317778818309307,
        0.013690841384232044,
        0.012413866817951202,
        0.0269630029797554,
        0.028944754973053932,
        0.0029359946493059397,
        0.007878164760768414,
        -0.004357762634754181,
        0.011471835896372795,
        0.0004557507927529514,
        -0.007745583076030016,
        0.0029202941805124283,
        0.003419221378862858,
        -0.036453086882829666,
        -0.01078101433813572,
        -0.017542699351906776,
        0.0044763884507119656,
        0.0014610192738473415,
        0.00882019568234682,
        0.023306528106331825,
        0.013928093016147614,
        -0.0039739725179970264,
        0.03938384726643562,
        0.028009703382849693,
        -0.030647387728095055,
        -0.01048095989972353,
        -0.013579193502664566,
        -0.003886747406795621,
        -0.014821277931332588,
        -0.04041659086942673,
        -0.010669365525245667,
        0.015309737995266914,
        0.039774615317583084,
        0.018212586641311646,
        0.007871187292039394,
        0.002977862721309066,
        0.005701028276234865,
        -0.009741291403770447,
        -0.019203463569283485,
        0.001721822191029787,
        -0.03430386260151863,
        0.03555990010499954,
        -0.011520681902766228,
        0.03201507776975632,
        0.025874434038996696,
        -0.03433177247643471,
        0.0054777320474386215,
        -0.012441778555512428,
        0.001868360210210085,
        -0.006545366253703833,
        -0.009231897071003914,
        0.00018066485063172877,
        0.01864522323012352,
        -0.013760620728135109,
        -0.017542699351906776,
        -0.009001622907817364,
        0.029140138998627663,
        0.014835233800113201,
        -0.012281284667551517,
        0.006904733367264271,
        0.034750454127788544,
        0.000417807896155864,
        -0.014974793419241905,
        -0.03299199789762497,
        -0.0038483685348182917,
        0.0041623786091804504,
        0.0078642088919878,
        0.0036494953092187643,
        -0.004567102529108524,
        -0.029921675100922585,
        0.002171903382986784,
        -0.02036181092262268,
        0.014276993460953236,
        -0.007494374644011259,
        -0.0025644160341471434,
        0.011541616171598434,
        0.030033323913812637,
        -0.002445789985358715,
        -0.004246114753186703,
        -0.020613020285964012,
        -0.008031681180000305,
        0.002318441402167082,
        0.006552344653755426,
        -0.0016049406258389354,
        0.012658096849918365,
        0.011150848120450974,
        0.0009516251157037914,
        0.017040282487869263,
        0.010173927992582321,
        -0.01744500733911991,
        -0.004776442889124155,
        0.009573819115757942,
        0.014200235716998577,
        0.019943131133913994,
        0.0031435901764780283,
        0.005163721740245819,
        -0.009224919602274895,
        -0.005885945167392492,
        0.0027440995909273624,
        -0.017137974500656128,
        -0.020180383697152138,
        0.02432531677186489,
        0.009608709253370762,
        0.0130209531635046,
        -0.021366644650697708,
        -0.6743541955947876,
        -0.02036181092262268,
        0.016970502212643623,
        -0.010864750482141972,
        0.026223333552479744,
        0.006841931492090225,
        0.0010432114358991385,
        -0.002459745854139328,
        0.014765453524887562,
        0.008673657663166523,
        0.00349597935564816,
        0.029782114550471306,
        -0.020012911409139633,
        0.001971285790205002,
        -0.0011400311486795545,
        -0.015002705156803131,
        0.014960837550461292,
        -0.03288034722208977,
        0.0037855664268136024,
        0.02671179361641407,
        0.002013153862208128,
        0.008834151551127434,
        -0.01838005892932415,
        -0.00833173468708992,
        -0.014723585918545723,
        -0.020529283210635185,
        0.005634737201035023,
        -0.0014130455674603581,
        -0.010348377749323845,
        0.011325297877192497,
        -0.009106293320655823,
        0.015714460983872414,
        -0.01851961947977543,
        -0.006730283610522747,
        0.05227919667959213,
        0.0007815362769179046,
        -0.003246515756472945,
        0.020389724522829056,
        -0.0015020150458440185,
        0.03840692713856697,
        -0.027758494019508362,
        -0.018687091767787933,
        0.008422449231147766,
        0.012441778555512428,
        -0.005634737201035023,
        0.009671512059867382,
        0.013816445134580135,
        0.01332798507064581,
        -0.008087504655122757,
        -0.04357064887881279,
        0.005526578053832054,
        -0.009915742091834545,
        -0.018687091767787933,
        0.0036285612732172012,
        -0.0014147900510579348,
        0.0062453122809529305,
        0.009217941202223301,
        0.004800865892320871,
        -0.0017410116270184517,
        0.0012324897106736898,
        -0.0063744052313268185,
        -0.007347836624830961,
        -0.04013746976852417,
        -0.020585108548402786,
        -0.023781033232808113,
        0.023892680183053017,
        0.01163233071565628,
        -0.004581058863550425,
        -0.02586047723889351,
        -0.032964084297418594,
        -0.0037088084500283003,
        0.025497620925307274,
        -0.006674459669739008,
        0.00014184971223585308,
        0.02784223109483719,
        0.0027772451285272837,
        0.005708006210625172,
        -0.008931843563914299,
        -0.005191633943468332,
        -0.0031156782060861588,
        0.01719379797577858,
        -0.01719379797577858,
        0.0038204563315957785,
        -0.013041886501014233,
        -0.0005067774327471852,
        -0.0012351064942777157,
        -0.02221796102821827,
        -0.01325122732669115,
        -0.0028906376101076603,
        0.016816986724734306,
        0.032042987644672394,
        0.0034802788868546486,
        -0.003684385446831584,
        -0.032629139721393585,
        -0.006189488340169191,
        0.01533764973282814,
        -0.029586730524897575,
        0.0026150064077228308,
        0.02340422011911869,
        -0.02849816344678402,
        0.012246394529938698,
        -0.004249603487551212,
        0.0076897586695849895,
        -0.0005586763145402074,
        0.017570611089468002,
        0.01020881813019514,
        -0.017110062763094902,
        0.01507248543202877,
        0.011276451870799065,
        0.0004662178107537329,
        -0.007347836624830961,
        -0.00916211772710085,
        -0.0017340336926281452,
        -0.015156221576035023,
        0.0107461242005229,
        -0.023976417258381844,
        -0.009231897071003914,
        -0.013097710907459259,
        0.020599063485860825,
        -0.022664552554488182,
        0.01586797833442688,
        -0.00766882486641407,
        0.017137974500656128,
        -0.00396699458360672,
        -0.0002498997200746089,
        0.004521745722740889,
        -0.010369312018156052,
        -0.012637162581086159,
        -0.013635016977787018,
        0.01765434630215168,
        0.009099315851926804,
        -0.024981249123811722,
        -0.013593149371445179,
        -0.016621602699160576,
        0.014556113630533218,
        -0.010236729867756367,
        0.01956631988286972,
        -0.01825445517897606,
        0.0012394677614793181,
        -0.007557176984846592,
        -0.020082691684365273,
        0.007585088722407818,
        0.008610854856669903,
        0.00649303151294589,
        -0.026823442429304123,
        -0.04086318239569664,
        -0.021003788337111473,
        0.005327704828232527,
        -0.0007911310531198978,
        -0.004964848980307579,
        -0.015965670347213745,
        -0.013048864901065826,
        -0.010536784306168556,
        0.030033323913812637,
        0.006597701460123062,
        -0.039439670741558075,
        -0.004071664530783892,
        -0.013279139064252377,
        -0.020640932023525238,
        -0.02485564537346363,
        -1.651824095461052e-05,
        0.01784973032772541,
        0.00026363765937276185,
        0.004319383762776852,
        0.002035832265391946,
        0.007508330978453159,
        8.259119931608438e-05,
        0.028721459209918976,
        -0.03603440523147583,
        -0.018421927466988564,
        0.023250704631209373,
        -0.004301938693970442,
        -0.004451965447515249,
        0.005955725442618132,
        0.004130977671593428,
        0.010453048162162304,
        -0.019189506769180298,
        0.0023114634677767754,
        0.0102855758741498,
        -0.020138515159487724,
        -0.007107095792889595,
        0.035950668156147,
        0.010341400280594826,
        -0.02955881878733635,
        0.027325857430696487,
        0.004612459801137447,
        0.021254995837807655,
        0.03343858942389488,
        -0.008834151551127434,
        0.017012370750308037,
        -0.013118645176291466,
        0.03452715650200844,
        -0.008464316837489605,
        0.015323693864047527,
        -0.015184133313596249,
        0.03271287679672241,
        -0.00676168454810977,
        0.007466462906450033,
        -0.014304905198514462,
        0.01021579559892416,
        0.025120809674263,
        0.006988469511270523,
        0.02579069696366787,
        0.005313748959451914,
        0.01685885339975357,
        -0.01507248543202877,
        -0.010508871637284756,
        -0.005432375241070986,
        0.0241997130215168,
        -0.01398391742259264,
        0.005631248001009226,
        -0.021520160138607025,
        0.014765453524887562,
        -0.002700486918911338,
        0.012692986987531185,
        0.00490902503952384,
        -0.007089650724083185,
        0.021380599588155746,
        -0.012511558830738068,
        -0.007110584527254105,
        0.005282348021864891,
        0.008038658648729324,
        0.021534116938710213,
        -0.010829860344529152,
        0.00200094236060977,
        0.006841931492090225,
        0.00011459188681328669,
        0.0384906642138958,
        0.013690841384232044,
        -0.025706961750984192,
        0.011743978597223759,
        0.002993563190102577,
        0.01620292291045189,
        0.008387559093534946,
        0.0296146422624588,
        -0.0009926208294928074,
        0.004047241527587175,
        -0.005938280373811722,
        0.017151931300759315,
        -0.0018474261742085218,
        -0.021785324439406395,
        -0.002539993030950427,
        0.010808926075696945,
        -0.014067653566598892,
        0.03173595666885376,
        -0.0009463916067034006,
        0.04700382426381111,
        0.017305446788668633,
        -0.012965128757059574,
        0.03684385493397713,
        -0.02473004162311554,
        -0.008520141243934631,
        -0.017905553802847862,
        0.0029621620196849108,
        -0.0034471333492547274,
        -0.016356438398361206,
        0.016147097572684288,
        0.008478272706270218,
        0.011311342008411884,
        0.04739459231495857,
        -0.00629764748737216,
        0.016119185835123062,
        -0.005254435818642378,
        0.002531270496547222,
        -0.02346004545688629,
        -0.011388100683689117,
        -0.008380580693483353,
        0.008045637048780918,
        0.0022730843629688025,
        -0.021910928189754486,
        0.0014810810098424554,
        -0.005414930172264576,
        0.006154598202556372,
        -0.011164803989231586,
        0.03971879184246063,
        0.023920593783259392,
        -0.010236729867756367,
        0.016970502212643623,
        0.005359106231480837,
        0.015519077889621258,
        -0.015044573694467545,
        -0.03486210107803345,
        0.039104726165533066,
        0.0031470791436731815,
        0.007557176984846592,
        -0.000177284877281636,
        -0.021143347024917603,
        0.007298990618437529,
        -0.03274078667163849,
        0.008603877387940884,
        -0.005481221247464418,
        0.03396891802549362,
        -0.005721962079405785,
        0.0069849807769060135,
        0.004622926935553551,
        -0.007647891063243151,
        0.023557737469673157,
        -0.00766882486641407,
        0.003834412433207035,
        -0.014779409393668175,
        0.006524432450532913,
        -0.004570591729134321,
        -0.019482582807540894,
        -0.021994663402438164,
        0.023320484906435013,
        0.012881392613053322,
        -0.021408511325716972,
        -0.015267869457602501,
        -0.012776723131537437,
        -0.024353228509426117,
        -0.006367427296936512,
        0.01193936262279749,
        0.005599847063422203,
        0.016021493822336197,
        0.02209235541522503,
        0.002848769538104534,
        -0.02253894880414009,
        -0.029921675100922585,
        0.02083631604909897,
        0.022231915965676308,
        -0.007319924887269735,
        -0.017821818590164185,
        0.0028383026365190744,
        0.007954923436045647,
        0.06665387749671936,
        0.017305446788668633,
        0.002180625917389989,
        0.009015579707920551,
        -0.005749874282628298,
        0.0032971061300486326,
        -0.0366484709084034,
        -0.013962983153760433,
        0.015170177444815636,
        -0.00018110097153112292,
        -0.03142892196774483,
        0.007773494813591242,
        0.016286658123135567,
        -0.0187847837805748,
        0.03363397344946861,
        0.013886225409805775,
        0.014074631035327911,
        -0.02830277942121029,
        0.008645744994282722,
        -0.015644682571291924,
        0.008785305544734001,
        0.017417093738913536,
        -0.0036355394404381514,
        -0.017500830814242363,
        0.028609810397028923,
        -0.0260419063270092,
        0.02214818075299263,
        0.024632349610328674,
        -0.011820736341178417,
        -0.024548612534999847,
        -0.0056661381386220455,
        0.015909846872091293,
        0.009469149634242058,
        0.008289867080748081,
        0.003529124893248081,
        0.015114353969693184,
        -0.0004448476538527757,
        0.019412802532315254,
        -0.004940425977110863,
        -0.003778588492423296,
        0.024311361834406853,
        0.01660764589905739,
        0.0015098652802407742,
        -0.024143889546394348,
        0.016761161386966705,
        -0.009280743077397346,
        0.00579872028902173,
        0.01997104287147522,
        -0.0010214050998911262,
        -0.0228180680423975,
        0.0008587304619140923,
        0.021589940413832664,
        -0.0214922484010458,
        0.012769744731485844,
        0.004438009578734636,
        0.01140205655246973,
        -0.017040282487869263,
        -0.008841129019856453,
        0.019468627870082855,
        -0.03578319773077965,
        -0.029502995312213898,
        -0.0005521344719454646,
        0.005076496861875057,
        -0.003539591794833541,
        -0.0053032818250358105,
        -0.038518574088811874,
        -0.011269474402070045,
        -0.0018090471858158708,
        -0.016356438398361206,
        0.01984543912112713,
        0.014597981236875057,
        -0.015323693864047527,
        -0.03522495552897453,
        -0.00012887499178759754,
        0.003939082380384207,
        0.002356820274144411,
        0.034610893577337265,
        -0.01653786562383175,
        -0.005617292132228613,
        0.0069256676360964775,
        0.006035972386598587,
        -0.03288034722208977,
        0.011129913851618767,
        -0.015044573694467545,
        -0.02068280056118965,
        0.002995307557284832,
        -0.005830121226608753,
        -0.004964848980307579,
        0.00833173468708992,
        0.015044573694467545,
        0.006053417455404997,
        -0.01101128850132227,
        0.02863772213459015,
        -0.017500830814242363,
        0.011213649995625019,
        -0.00048060991684906185,
        0.022399388253688812,
        0.012713920325040817,
        -0.007626956794410944,
        0.00441358657553792,
        -0.0013781555462628603,
        -0.04284493625164032,
        -0.019203463569283485,
        -0.01838005892932415,
        0.021631808951497078,
        -0.006210422143340111,
        0.02129686437547207,
        0.028344646096229553,
        -0.0013982172822579741,
        -0.0143746854737401,
        -0.00793398916721344,
        -0.01179980207234621,
        0.012637162581086159,
        -0.020724667236208916,
        0.02319488115608692,
        0.0073617929592728615,
        0.0033738643396645784,
        -0.017961379140615463,
        -0.027828274294734,
        0.00021162974007893354,
        0.005167210940271616,
        -0.03751374036073685,
        0.02869354747235775,
        0.011478814296424389,
        -0.012692986987531185,
        0.023948505520820618,
        0.007913054898381233,
        -0.005111386999487877,
        0.0040297964587807655,
        0.009469149634242058,
        0.008785305544734001,
        0.00013945101818535477,
        0.0022329608909785748,
        -0.019984999671578407,
        -0.012504580430686474,
        -0.014283970929682255,
        0.0007745582843199372,
        0.005721962079405785,
        -0.018589399755001068,
        -0.02975420281291008,
        -0.005191633943468332,
        0.009859917685389519,
        0.009671512059867382,
        -0.0009786648442968726,
        -0.004427542444318533,
        -0.019454671069979668,
        -0.006412784568965435,
        0.01159744057804346,
        -0.003140101209282875,
        0.032433755695819855,
        -0.011660242453217506,
        0.006322070490568876,
        -0.005865011364221573,
        -0.012581339105963707,
        -0.020920051261782646,
        -0.03106606751680374,
        0.014346773736178875,
        0.019873350858688354,
        0.03578319773077965,
        0.030926506966352463,
        0.03846275061368942,
        0.008841129019856453,
        0.0005229140515439212,
        -0.009566841647028923,
        0.0064895423129200935,
        -0.0036529842764139175,
        0.01405369769781828,
        0.0025940723717212677,
        -0.005017183721065521,
        0.019747747108340263,
        0.01818467490375042,
        0.016147097572684288,
        0.03751374036073685,
        -0.01414441131055355,
        0.0010999076766893268,
        0.00394954951480031,
        -0.0035640147980302572,
        -0.03148474916815758,
        0.006053417455404997,
        -0.027814317494630814,
        -0.02221796102821827,
        -0.001971285790205002,
        0.011108980514109135,
        -0.008220086805522442,
        -0.022915760055184364,
        0.015323693864047527,
        0.019329067319631577,
        0.004779931623488665,
        0.02022225223481655,
        0.0016145353438332677,
        0.02393454872071743,
        -0.0020619998686015606,
        0.01414441131055355,
        0.012246394529938698,
        0.004071664530783892,
        -0.023292573168873787,
        0.0027912009973078966,
        -0.010313487611711025,
        0.027870142832398415,
        0.03782077506184578,
        0.024492789059877396,
        -0.0037332314532250166,
        0.0059975930489599705,
        -0.0013249482726678252,
        -0.0024702129885554314,
        0.03034035488963127,
        -0.015881933271884918,
        -0.010501894168555737,
        0.0034401551820337772,
        -0.018631266430020332,
        0.005397485103458166,
        -0.02539992891252041,
        -0.009636621922254562,
        0.007613000925630331,
        0.008966733701527119,
        -0.0001524257386336103,
        0.010557717643678188,
        0.02207840047776699,
        -0.0024911470245569944,
        -0.01958027482032776,
        0.002878426108509302,
        0.00819915346801281,
        0.041756369173526764,
        0.009671512059867382,
        0.02096191979944706,
        0.032294195145368576,
        0.014346773736178875,
        -0.00537306210026145,
        -0.020878184586763382,
        -0.004982294049113989,
        0.0019259287510067225,
        -0.0021963263861835003,
        0.030117059126496315,
        0.0028034124989062548,
        -0.017375227063894272,
        0.024213669821619987,
        0.015826109796762466,
        -0.02221796102821827,
        -0.03271287679672241,
        0.020920051261782646,
        0.008143329061567783,
        0.02135268785059452,
        -0.017500830814242363,
        -0.020473459735512733,
        -0.0036285612732172012,
        0.0269630029797554,
        -0.021045655012130737,
        -0.004570591729134321,
        -0.0049857827834784985,
        -0.01599358208477497,
        -0.008876019157469273,
        0.006971024442464113,
        0.0013912392314523458,
        -0.004591525532305241,
        0.029586730524897575,
        0.02386476844549179,
        0.016091274097561836,
        -0.012469690293073654,
        -0.0033442077692598104,
        -0.006674459669739008,
        0.0022294719237834215,
        0.007292012684047222,
        0.0003829179040621966,
        0.02856794185936451,
        0.0006773023633286357,
        0.014263037592172623,
        0.01140205655246973,
        -0.00394954951480031,
        0.015588858164846897,
        0.026544321328401566,
        -0.03522495552897453,
        -0.022580817341804504,
        -0.0007915671449154615,
        -0.001606685109436512,
        0.0012577850138768554,
        -0.0005124470917508006,
        -0.009266787208616734,
        0.004888090770691633,
        -0.013334962539374828,
        -0.019594231620430946,
        0.012316174805164337,
        -0.01560281403362751,
        -0.018100939691066742,
        0.001441829837858677,
        0.0034698117524385452,
        -0.008254976943135262,
        0.013551280833780766,
        0.01144392415881157,
        0.007082672789692879,
        -0.02789805456995964,
        0.00396699458360672,
        0.00039055009256117046,
        -0.0034698117524385452,
        -0.024646304547786713,
        0.018435882404446602,
        -0.0009463916067034006,
        0.0008251488325186074,
        -0.0013432655250653625,
        -0.022929716855287552,
        0.005240479949861765,
        0.007194320671260357,
        0.01514226570725441,
        -0.003593671368435025,
        0.03240584582090378,
        -0.010815904475748539,
        -0.013676885515451431,
        0.016314569860696793,
        -0.0032744277268648148,
        -0.015323693864047527,
        0.0046647945418953896,
        0.009336567483842373,
        0.0009263298707082868,
        0.0037297424860298634,
        0.008492229506373405,
        -0.005470754113048315,
        0.015519077889621258,
        -0.0042635598219931126,
        0.004682239610701799,
        -0.023767076432704926,
        0.007773494813591242,
        0.006873332429677248,
        0.0038832584396004677,
        0.01871500350534916,
        -0.01279067900031805,
        0.024548612534999847,
        -0.01521204598248005,
        0.023515868932008743,
        0.021408511325716972,
        -0.059340935200452805,
        -0.0038169673644006252,
        0.0008718142053112388,
        0.008645744994282722,
        -0.022399388253688812,
        -0.02354378066956997,
        -0.0009926208294928074,
        0.01791951060295105,
        -0.013914137147367,
        -0.00337211973965168,
        0.002133524278178811,
        0.004497322719544172,
        -0.008324757218360901,
        0.0016250023618340492,
        0.0031156782060861588,
        0.0035866934340447187,
        -0.012741832993924618,
        -0.004308916628360748,
        -0.0228180680423975,
        -0.003012752626091242,
        -0.038183629512786865,
        0.011088046245276928,
        -0.021785324439406395,
        0.020864227786660194,
        0.018896430730819702,
        -0.029586730524897575,
        -0.026893222704529762,
        -0.02577674202620983,
        -0.04080735892057419,
        -0.00958777591586113,
        -0.03047991544008255,
        0.001362454961054027,
        -0.0008238404407165945,
        0.02386476844549179,
        0.002724909922108054,
        0.03879769518971443,
        -0.007766516879200935,
        -0.007037315517663956,
        -0.019803570583462715,
        -0.007326902821660042,
        -0.00608481839299202,
        0.0005150638171471655,
        -0.012092878110706806,
        -0.013146556913852692,
        -0.01378853339701891,
        -0.0059243240393698215,
        -0.006594212260097265,
        0.006820997688919306,
        -0.009238875471055508,
        0.019538408145308495,
        -0.0013519880594685674,
        -0.029000578448176384,
        0.012441778555512428,
        0.01726357825100422,
        -0.010704255662858486,
        0.014095565304160118,
        0.003911170642822981,
        -0.012358042411506176,
        -0.01705423928797245,
        0.0002594944671727717,
        -0.009901785291731358,
        0.0016869321698322892,
        -0.0056800940074026585,
        0.019426759332418442,
        -0.00902255717664957,
        -0.005271880887448788,
        -0.0022207493893802166,
        -0.005299793090671301,
        0.001645064097829163,
        -0.004999738652259111,
        0.014932925812900066,
        -0.008722503669559956,
        -0.012316174805164337,
        0.012225460261106491,
        0.009762225672602654,
        -0.0015883678570389748,
        -0.010955464094877243,
        0.007515308912843466,
        -0.03357814997434616,
        -0.029251787811517715,
        0.01190447248518467,
        -0.02359960414469242,
        0.01593775860965252,
        -0.0025696493685245514,
        -0.0005172444507479668,
        -0.019008079543709755,
        -0.013893202878534794,
        -0.008910909295082092,
        0.00030681406497024,
        -0.022790156304836273,
        0.0038448793347924948,
        -0.009294699877500534,
        -0.009099315851926804,
        -0.0036006493028253317,
        0.004462432581931353,
        -0.012113812379539013,
        -0.01850566267967224,
        -0.020780492573976517,
        0.004399630706757307,
        -0.03254540264606476,
        -0.010159972123801708,
        0.010655409656465054,
        -0.019524451345205307,
        -0.010955464094877243,
        0.005282348021864891,
        0.012302218936383724,
        -0.00026821697247214615,
        0.024032240733504295,
        0.2150341272354126,
        -0.01824049837887287,
        -0.015058529563248158,
        -0.002360309474170208,
        -0.01949653960764408,
        0.0059836371801793575,
        0.018533574417233467,
        0.006918689701706171,
        0.003771610325202346,
        0.001927673234604299,
        -0.00020236207637935877,
        0.01825445517897606,
        -0.004839244764298201,
        -0.012727877125144005,
        0.0038972145412117243,
        -0.025818610563874245,
        -0.02506498619914055,
        -0.011855626478791237,
        -0.02273433282971382,
        -0.009643599390983582,
        0.016872810199856758,
        0.005742896348237991,
        -0.004008862655609846,
        -0.012211504392325878,
        0.025930257514119148,
        -0.0005717601161450148,
        -0.016147097572684288,
        0.006318581290543079,
        0.011095023714005947,
        0.006022016052156687,
        -0.017012370750308037,
        0.024827733635902405,
        0.008931843563914299,
        0.010404202155768871,
        -0.01394902728497982,
        -0.013425677083432674,
        -0.005345149897038937,
        0.011457880027592182,
        0.018212586641311646,
        0.01375364325940609,
        -0.011709088459610939,
        0.004758997820317745,
        -0.003977461718022823,
        -0.021143347024917603,
        -0.005676605273038149,
        0.0005560595891438425,
        -0.00021849870972801,
        -0.01758456602692604,
        -0.006081329192966223,
        0.017542699351906776,
        -0.005955725442618132,
        -0.014695673249661922,
        0.00997854396700859,
        0.008038658648729324,
        -0.01239991094917059,
        0.004710151813924313,
        -0.012839525006711483,
        0.008673657663166523,
        -0.00579872028902173,
        0.02577674202620983,
        -0.01671929471194744,
        0.02301345206797123,
        -0.010585630312561989,
        0.011709088459610939,
        -0.008282888680696487,
        0.011283430270850658,
        0.0007226594025269151,
        0.007626956794410944,
        0.01124156266450882,
        0.008227065205574036,
        0.025037072598934174,
        -0.005317238159477711,
        -0.018086982890963554,
        -0.000983026111498475,
        -0.030731122940778732,
        -0.04013746976852417,
        0.03165221959352493,
        0.034024741500616074,
        0.0068070413544774055,
        0.019329067319631577,
        -0.002163180848583579,
        0.011492770165205002,
        0.008966733701527119,
        -0.01995708793401718,
        -0.022762244567275047,
        -0.027493329718708992,
        0.01607731729745865,
        -0.005638225935399532,
        -0.03338276594877243,
        -0.0033564192708581686,
        -0.014486333355307579,
        -0.03773703798651695,
        -0.007194320671260357,
        -0.014514245092868805,
        -0.005687071941792965,
        0.016495998948812485,
        -0.0058545442298054695,
        0.010557717643678188,
        -0.00013618008233606815,
        0.007766516879200935,
        -0.02280411310493946,
        0.04703173786401749,
        0.013439632952213287,
        0.0009071403183043003,
        -0.017291489988565445,
        0.01600753888487816,
        -0.0023463533725589514,
        0.004954381845891476,
        0.004685728810727596,
        0.007298990618437529,
        -0.011234584264457226,
        -0.022650595754384995,
        0.0021666698157787323,
        0.004040263593196869,
        0.008750415407121181,
        -0.018086982890963554,
        -0.022762244567275047,
        -0.029195962473750114,
        0.003980950452387333,
        -0.004549657925963402,
        -0.0033040842972695827,
        -0.036146052181720734,
        -0.010920573957264423,
        0.026795530691742897,
        -0.016482042148709297,
        -0.01712401770055294,
        -0.027786405757069588,
        -0.008485251106321812,
        -0.029530907049775124,
        -0.023501912131905556,
        0.01318842452019453,
        -0.013495457358658314,
        0.021534116938710213,
        0.0024632348213344812,
        0.006161576136946678,
        0.011688154190778732,
        0.015491166152060032,
        -0.010885683819651604,
        -0.007982835173606873,
        0.009141183458268642,
        0.021059611812233925,
        0.017765995115041733,
        0.024311361834406853,
        -0.0061127301305532455,
        0.012078922241926193,
        -0.011234584264457226,
        0.03776495158672333,
        0.009636621922254562,
        -0.017096105962991714,
        -0.021143347024917603,
        -0.028805194422602654,
        -0.01024370826780796,
        -0.00952497310936451,
        0.002150969346985221,
        0.018617311492562294,
        0.00628020241856575,
        -0.02207840047776699,
        0.001118224929086864,
        0.001997453160583973,
        0.020012911409139633,
        -0.035922758281230927,
        0.015770286321640015,
        0.019468627870082855,
        0.005027650855481625,
        -0.01691467873752117,
        -0.019859395921230316,
        -0.1832144409418106,
        0.005987126380205154,
        0.01203007623553276,
        -0.04959964379668236,
        0.006855887360870838,
        0.02664201334118843,
        -0.014570069499313831,
        0.0015874955570325255,
        -0.01514226570725441,
        -0.003263960825279355,
        -0.005655671004205942,
        -0.01352336909621954,
        -0.0014828256098553538,
        -0.0016014515422284603,
        0.01444446574896574,
        0.016370393335819244,
        -0.02492542564868927,
        0.006004571449011564,
        0.022315653041005135,
        -0.007759538944810629,
        0.012420844286680222,
        -0.008917887695133686,
        0.006199955474585295,
        0.009336567483842373,
        0.018463794142007828,
        -0.010453048162162304,
        -0.03773703798651695,
        -0.021129392087459564,
        -0.009713379666209221,
        -0.031373098492622375,
        0.006566300522536039,
        -0.016147097572684288,
        0.012232438661158085,
        0.018170718103647232,
        0.01193936262279749,
        6.411039794329554e-05,
        -0.0015901123406365514,
        0.00886206328868866,
        -0.010683322325348854,
        0.024171801283955574,
        0.011471835896372795,
        0.021645763888955116,
        -0.0013415210414677858,
        0.017347315326333046,
        -0.011792824603617191,
        0.02513476461172104,
        0.02432531677186489,
        -0.027591021731495857,
        0.0057394071482121944,
        -0.006636080332100391,
        0.015700506046414375,
        -0.032964084297418594,
        0.013976939022541046,
        -0.008338713087141514,
        0.020864227786660194,
        0.02683739736676216,
        -0.0047380635514855385,
        0.00809448305517435,
        -0.011911450885236263,
        -0.019887307658791542,
        -0.0031470791436731815,
        -0.00836662482470274,
        0.019022034481167793,
        -0.008938821032643318,
        -0.006074351258575916,
        -0.010132059454917908,
        -0.017947422340512276,
        0.03449924662709236,
        -0.011360188014805317,
        0.02142246812582016,
        -0.0012586571974679828,
        -0.007940966635942459,
        -0.006126686464995146,
        -0.010557717643678188,
        0.004246114753186703,
        -0.005212567746639252,
        -0.014318861067295074,
        0.02147829160094261,
        0.012888371013104916,
        0.004308916628360748,
        0.0014365962706506252,
        0.014584025368094444,
        -0.015435341745615005,
        0.0014706141082569957,
        -0.009141183458268642,
        0.008869041688740253,
        0.013446611352264881,
        -0.0022033043205738068,
        -0.019664011895656586,
        -0.008638767525553703,
        0.024771910160779953,
        -0.01659369096159935,
        -0.02994958683848381,
        0.00048802405945025384,
        -0.00770371500402689,
        0.018435882404446602,
        -0.0014453188050538301,
        -0.01087172795087099,
        0.006266246549785137,
        -0.023250704631209373,
        -0.004082131665199995,
        -0.01772412657737732,
        -0.016091274097561836,
        -0.006060395389795303,
        0.030563650652766228,
        -0.0006262757233344018,
        -0.0367601178586483,
        -0.0064790756441652775,
        0.019929176196455956,
        -0.0134815014898777,
        0.005261413753032684,
        0.011813758872449398,
        0.013341940939426422,
        0.0175147857517004,
        -0.011841670610010624,
        0.04362647235393524,
        -0.027828274294734,
        -0.025274325162172318,
        0.0014427020214498043,
        7.457740139216185e-05,
        0.050939418375492096,
        0.006475586444139481,
        -0.0019643076229840517,
        -0.007389704696834087,
        -0.023362353444099426,
        0.0024789355229586363,
        -0.07820945233106613,
        -0.03114980272948742,
        0.03994208574295044,
        -0.00034257632796652615,
        0.0044659217819571495,
        0.014486333355307579,
        0.0005128831835463643,
        0.02989376336336136,
        -0.03198716416954994,
        0.01463984977453947,
        -0.013467544689774513,
        -0.023097189143300056,
        -0.005781275220215321,
        -0.013321006670594215,
        0.007382726762443781,
        0.0038448793347924948,
        -0.004790398757904768,
        -0.014918969944119453,
        -0.0035413363948464394,
        0.009231897071003914,
        -0.017807861790060997,
        0.00649303151294589,
        0.0395234078168869,
        -0.010257664136588573,
        -0.019356979057192802,
        -0.005941769108176231,
        -0.03966296836733818,
        0.018226543441414833,
        0.019077859818935394,
        0.005254435818642378,
        0.008568987250328064,
        -0.018282366916537285,
        0.011562550440430641,
        -0.013041886501014233,
        -0.018477750942111015,
        -0.014332816936075687,
        0.00558589119464159,
        -0.026488497853279114,
        0.02639080584049225,
        -0.020194338634610176,
        -0.004685728810727596,
        -0.008387559093534946,
        0.01305584330111742,
        -0.014165345579385757,
        0.020012911409139633,
        -0.013467544689774513,
        0.019677966833114624,
        0.01798929087817669,
        0.011723044328391552,
        -0.02274828776717186,
        -0.02313905581831932,
        -0.02380894497036934,
        -0.023697296157479286,
        -0.0074315727688372135,
        0.0157284177839756,
        -0.0031994141172617674,
        0.03865813463926315,
        -0.003740209387615323,
        -0.0011818992206826806,
        -0.0017209498910233378,
        0.010864750482141972,
        -0.009504039771854877,
        -0.027758494019508362,
        0.001992219826206565,
        0.01002041157335043,
        0.004075153730809689,
        -0.010962442494928837,
        -0.009873873554170132,
        0.012720898725092411,
        -0.006405806168913841,
        -0.013237270526587963,
        0.03525286912918091,
        -0.028135307133197784,
        0.005624270066618919,
        -0.030591564252972603,
        -0.006095285061746836,
        0.0007658358081243932,
        -0.0010336166014894843,
        0.021841147914528847,
        -0.0024353228509426117,
        -0.035727374255657196,
        -0.02729794569313526,
        -0.007815362885594368,
        -0.015030617825686932,
        -0.01067634392529726,
        0.000983026111498475,
        -0.023487957194447517,
        -0.007271078880876303,
        -0.0011661986354738474,
        -0.03034035488963127,
        0.0004827905504498631,
        0.007452506572008133,
        0.0029883296228945255,
        0.0029918185900896788,
        -0.013195402920246124,
        -0.0116393081843853,
        -0.016551822423934937,
        0.007989812642335892,
        0.009859917685389519,
        0.008610854856669903,
        -0.01758456602692604,
        -0.00419726874679327,
        -0.08580151945352554,
        0.014891057275235653,
        -0.006343004293739796,
        0.011067111976444721,
        0.008806238882243633,
        -0.02632102556526661,
        0.025553446263074875,
        -0.024185756221413612,
        -0.00628020241856575,
        -0.003443644382059574,
        -0.02023620717227459,
        -0.001441829837858677,
        -0.014207213185727596,
        0.009657555259764194,
        0.004922980908304453,
        -0.005188144743442535,
        0.03251749277114868,
        -0.021715544164180756,
        0.02678157389163971,
        -0.003047642530873418,
        0.0024440453853458166,
        0.01574237458407879,
        0.013000018894672394,
        0.006165065336972475,
        0.00816426333039999,
        0.010125081986188889,
        -0.018547531217336655,
        0.009776181541383266,
        -0.00817124079912901,
        0.003830923466011882,
        -0.014032763428986073,
        -0.01090661808848381,
        -0.0143746854737401,
        0.030535738915205002,
        -0.02439509704709053,
        -0.01094150822609663,
        0.015560945495963097,
        0.0161889661103487,
        0.008038658648729324,
        0.01276276633143425,
        -0.00702684884890914,
        -0.022231915965676308,
        0.027786405757069588,
        -0.02710256166756153,
        -0.008917887695133686,
        -0.010990354232490063,
        -0.02406015247106552,
        -0.0006018527201376855,
        0.018435882404446602,
        -0.03290826082229614,
        0.013872269541025162,
        0.002733632456511259,
        -0.03539242967963219,
        -0.021450379863381386,
        -0.021003788337111473,
        -0.025288281962275505,
        0.023320484906435013,
        -0.0021370132453739643,
        -0.0107461242005229,
        0.003424454713240266,
        0.014821277931332588,
        0.007585088722407818,
        0.02658618986606598,
        0.024213669821619987,
        0.019287198781967163,
        0.015323693864047527,
        0.003740209387615323,
        0.010725189931690693,
        0.012923261150717735,
        -0.01904994621872902,
        -0.029586730524897575,
        -0.01885456219315529,
        0.008415470831096172,
        -0.005777786020189524,
        0.013865291140973568,
        0.00539050716906786,
        0.008310801349580288,
        0.027353771030902863,
        -0.020445547997951508,
        0.012581339105963707,
        0.014556113630533218,
        0.00649303151294589,
        0.007180364802479744,
        0.013614082708954811,
        0.028191130608320236,
        0.022832024842500687,
        -0.014835233800113201,
        -0.01691467873752117,
        -0.005990615114569664,
        -0.007738604675978422,
        -0.009015579707920551,
        -0.002198070753365755,
        -0.004186801612377167,
        0.008813217282295227,
        0.01341869868338108,
        -0.003530869260430336,
        0.011911450885236263,
        -0.009203985333442688,
        0.015309737995266914,
        0.01903599128127098,
        0.010690299794077873,
        -0.02076653577387333,
        -0.013383808545768261,
        -0.010097169317305088,
        -0.028526075184345245,
        0.013935071416199207,
        -0.01850566267967224,
        -0.021115435287356377,
        0.0028121350333094597,
        0.01325122732669115,
        0.018212586641311646,
        0.013711774721741676,
        0.017417093738913536,
        0.016747206449508667,
        -0.026027949526906013,
        0.04680844023823738,
        -0.004692706745117903,
        -0.0077944290824234486,
        -0.04396141692996025,
        0.011995186097919941,
        0.00932261161506176,
        0.0061859991401433945,
        0.028079481795430183,
        -0.02294367179274559,
        0.024841688573360443,
        0.030452003702521324,
        0.030452003702521324,
        -0.012741832993924618,
        0.010320466011762619,
        -0.006395339500159025,
        0.003106955671682954,
        -0.019008079543709755,
        -0.020138515159487724,
        -0.009371457621455193,
        -0.01613314263522625,
        0.008764371275901794,
        -0.012804634869098663,
        0.01613314263522625,
        -0.03181969374418259,
        0.08898349106311798,
        -0.002489402424544096,
        -0.01005530171096325,
        -0.007752561010420322,
        -0.002280062297359109,
        -0.013369852676987648,
        -0.005027650855481625,
        0.006890777498483658,
        -0.00916211772710085,
        -0.003607627237215638,
        -0.006241823546588421,
        0.0012098111910745502,
        0.013928093016147614,
        0.0009010345675051212,
        0.007871187292039394,
        -0.016300614923238754,
        -0.0007479546475224197,
        0.018603354692459106,
        0.00720827654004097,
        0.005069518927484751,
        0.016091274097561836,
        0.028079481795430183,
        0.010571673512458801,
        -0.01371875312179327,
        -0.023585649207234383,
        0.010599586181342602,
        0.025288281962275505,
        0.004888090770691633,
        -0.0157284177839756,
        -0.037262532860040665,
        -0.0031505681108683348,
        -0.012057988904416561,
        -0.03801615908741951,
        -0.005013694986701012,
        -0.009071403183043003,
        -0.020850270986557007,
        -0.0002536067913752049,
        0.0016267468454316258,
        0.011004310101270676,
        0.023767076432704926,
        -0.001156603917479515,
        0.04577569663524628,
        -0.013209358789026737,
        -0.01824049837887287,
        -0.0051009198650717735,
        -0.005774297285825014,
        -0.024423008784651756,
        -0.005135810002684593,
        0.006091796327382326,
    ]
    articles = [
        Article(
            title="Test Article",
            summary="This is a test article",
            url="https://example.com",
        )
        for _ in range(10)
    ]
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session
    mock_session.return_value.query.return_value.order_by.return_value.limit.return_value = (
        articles
    )
    articles = repo.get_by_theme_embedding(query_embedding)
    assert len(articles) > 0


def test_enhance_article():
    # Create a mock session
    mock_session = MagicMock()

    # Create the repository and set the mock session
    repo = ArticleRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Create a new article, themes, and embedding
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )
    themes = [Theme(title="Theme 1"), Theme(title="Theme 2")]
    embedding = [1, 2, 3]
    mock_session.return_value.merge.return_value = article
    # Call the enhance method
    enhanced_article = repo.enhance(article, themes, embedding)

    # Assert that the associations were added and the article was merged
    mock_session.return_value.add.assert_called()
    mock_session.return_value.commit.assert_called()
    mock_session.return_value.merge.assert_called_with(article)

    assert len(mock_session.return_value.add.call_args_list) == 2
    assert enhanced_article.embedding == embedding


def test_get_all_themes():
    # Create a mock session and query
    mock_query = MagicMock()
    mock_session = MagicMock()
    mock_session.return_value.query.return_value = mock_query

    # Create the repository and set the mock session
    repo = ThemeRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Mock the query result
    mock_query.all.return_value = [
        Theme(title="Test Theme 1"),
        Theme(title="Test Theme 2"),
    ]

    # Call the get_all method
    themes = repo.get_all()

    # Assert the result
    assert len(themes) == 2
    assert themes[0].original_title == "Test Theme 1"
    assert themes[1].original_title == "Test Theme 2"


def test_get_theme_by_title():
    # Create a mock session
    mock_session = MagicMock()
    mock_session.return_value.query.return_value.filter.return_value.all.return_value = [
        Theme(title="Test Theme")
    ]

    # Create the repository and set the mock session
    repo = ThemeRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Call the get_by_title method
    theme = repo.get_by_title("Test Theme")

    # Assert the result
    assert theme.original_title == "Test Theme"


def test_get_theme_by_titles():
    # Create a mock session and query
    mock_query = MagicMock()
    mock_session = MagicMock()
    mock_session.return_value.query.return_value = mock_query

    # Create the repository and set the mock session
    repo = ThemeRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Mock the query result
    mock_query.filter.return_value.all.return_value = [Theme(title="Test Theme")]

    # Call the get_by_titles method
    themes = repo.get_by_titles(["Test Theme"])

    # Assert the result
    assert len(themes) == 1
    assert themes[0].original_title == "Test Theme"


def test_add_related_theme():
    # Create a mock session
    mock_session = MagicMock()

    # Create the repository and set the mock session
    repo = ThemeRepository("username", "password", "dbname", "db_cluster_endpoint")
    repo.session = mock_session

    # Create a new article and theme
    article = Article(
        title="Test Article",
        summary="This is a test article",
        url="https://example.com",
    )
    theme = Theme(title="Test Theme")

    # Call the add_related method
    association = repo.add_realted(article, ["Test Theme"])

    # Assert that the theme was added and the association was created
    mock_session.return_value.add.assert_called()
    mock_session.return_value.commit.assert_called()
    assert association.article_id == article._id
    assert association.theme_id == theme._id
